<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard â€” Company Overview</title>

  <style>
    :root {
      color-scheme: light dark;

      /* Core palette (blue + light blue) */
      --blue-900: #0B3A82;
      --blue-700: #305CDE;
      --blue-600: #2F7AE5;
      --blue-500: #3B82F6;
      --blue-100: #E6F0FF;
      --blue-050: #F4F8FF;

      --neutral-0: #ffffff;
      --neutral-50: #F7F9FC;
      --neutral-200: #E5E7EB;
      --neutral-300: #D1D5DB;
      --neutral-600: #4B5563;
      --neutral-900: #111827;

      --primary-bg: var(--neutral-0);
      --page-bg: var(--blue-050);
      --primary-text: var(--neutral-900);
      --secondary-text: var(--neutral-600);

      --surface: var(--neutral-0);
      --surface-alt: var(--neutral-50);
      --divider: var(--neutral-200);

      --button-bg: var(--blue-700);
      --button-hover-bg: #244DC6;
      --button-text: #ffffff;

      --button-secondary-bg: #EAF0FF;
      --button-secondary-text: var(--blue-700);
      --button-secondary-hover-bg: #DBE6FF;

      --input-border: var(--neutral-300);
      --input-focus: var(--blue-600);

      --backdrop: rgba(11, 58, 130, 0.35);

      --radius-md: 10px;
      --radius-sm: 8px;

      --shadow-lg: 0 10px 30px rgba(17, 24, 39, 0.18);
      --shadow-md: 0 6px 18px rgba(17, 24, 39, 0.14);
      --focus-ring: 0 0 0 3px rgba(47, 122, 229, 0.28);
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --page-bg: #0b1220;
        --primary-bg: #0f172a;
        --surface: #0f172a;
        --surface-alt: #0b1324;
        --primary-text: #E5E7EB;
        --secondary-text: #9CA3AF;
        --divider: #1f2937;

        --button-bg: #3B82F6;
        --button-hover-bg: #2563EB;

        --button-secondary-bg: #17223a;
        --button-secondary-text: #c9d9ff;
        --button-secondary-hover-bg: #1b2a48;

        --input-border: #334155;
        --input-focus: #60A5FA;

        --backdrop: rgba(2, 6, 23, 0.55);
        --shadow-lg: 0 12px 30px rgba(0, 0, 0, 0.5);
        --shadow-md: 0 8px 22px rgba(0, 0, 0, 0.45);
        --focus-ring: 0 0 0 3px rgba(96, 165, 250, 0.35);
      }
    }

    * { box-sizing: border-box; }
    body {
      font-family: 'Inter', 'Segoe UI', Roboto, system-ui, -apple-system, sans-serif;
      background: radial-gradient(1200px 600px at 10% -10%, #f0f6ff 0%, var(--page-bg) 45%), var(--page-bg);
      color: var(--primary-text);
      margin: 0;
      padding: 48px 20px;
      display: grid;
      place-items: start center;
      min-height: 100svh;
    }

    .container {
      width: 100%;
      max-width: 980px;
      background: linear-gradient(180deg, var(--surface) 0%, var(--surface-alt) 100%);
      border: 1px solid var(--divider);
      border-radius: 16px;
      box-shadow: var(--shadow-lg);
      padding: 28px;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 18px;
    }

    .title-lg {
      font-size: 1.35rem;
      font-weight: 700;
      color: var(--blue-900);
      letter-spacing: 0.2px;
    }

    .subtle {
      color: var(--secondary-text);
      font-size: 0.95rem;
    }

    .btn {
      padding: 12px 18px;
      border: none;
      border-radius: 12px;
      background: var(--button-bg);
      color: var(--button-text);
      font-size: 0.98rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.08s ease, background 0.15s ease, box-shadow 0.15s ease;
      box-shadow: 0 6px 16px rgba(48, 92, 222, 0.28);
    }
    .btn:hover { background: var(--button-hover-bg); transform: translateY(-1px); box-shadow: 0 8px 20px rgba(48, 92, 222, 0.35); }
    .btn:active { transform: translateY(0); }
    .btn:focus-visible { outline: none; box-shadow: var(--focus-ring); }
    .btn.secondary {
      background: var(--button-secondary-bg);
      color: var(--button-secondary-text);
      box-shadow: 0 4px 12px rgba(48, 92, 222, 0.12);
    }
    .btn.secondary:hover { background: var(--button-secondary-hover-bg); box-shadow: 0 6px 14px rgba(48, 92, 222, 0.16); }

    /* Stats grid */
    .stats {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 16px;
      margin-bottom: 18px;
    }
    .stat {
      grid-column: span 12;
      background: linear-gradient(180deg, var(--neutral-0) 0%, var(--surface-alt) 100%);
      border: 1px solid var(--divider);
      border-radius: 14px;
      padding: 18px;
      box-shadow: var(--shadow-md);
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: center;
    }
    @media (min-width: 760px) {
      .stat { grid-column: span 6; }
    }
    @media (min-width: 1020px) {
      .stat { grid-column: span 3; }
    }
    .stat .label { color: var(--secondary-text); font-size: 0.95rem; }
    .stat .value { font-size: 1.8rem; font-weight: 800; color: var(--blue-900); }
    .pill { padding: 6px 10px; border-radius: 999px; font-weight: 700; font-size: 0.8rem; }
    .pill.sub { background: #EAF0FF; color: #244DC6; }
    .pill.app { background: #E8FBEE; color: #1d7837; }
    .pill.rej { background: #FFE9E9; color: #8f2323; }
    .pill.tot { background: #F3F4F6; color: #111827; }

    /* Inline info cards */
    .cards {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 16px;
      margin-top: 8px;
    }
    .card {
      grid-column: span 12;
      background: linear-gradient(180deg, var(--neutral-0) 0%, var(--surface-alt) 100%);
      border: 1px solid var(--divider);
      border-radius: 14px;
      padding: 18px;
      box-shadow: var(--shadow-md);
    }
    @media (min-width: 720px) { .card { grid-column: span 6; } }

    /* Modal */
    dialog {
      border: none;
      border-radius: 16px;
      box-shadow: var(--shadow-lg);
      padding: 0;
      background: linear-gradient(180deg, var(--surface) 0%, var(--surface-alt) 100%);
      max-width: 560px;
      width: calc(100% - 32px);
    }
    dialog::backdrop { background: var(--backdrop); backdrop-filter: blur(4px); }
    .dialog-header { padding: 18px 22px 8px; border-bottom: 1px solid var(--divider); }
    .dialog-title { font-size: 1.15rem; font-weight: 700; color: var(--blue-900); margin: 0 0 6px 0; }
    .dialog-sub { margin: 0; color: var(--secondary-text); font-size: 0.95rem; }
    .dialog-body { padding: 20px 22px 6px; }
    .row { margin-bottom: 16px; display: flex; flex-direction: column; gap: 8px; }
    label { font-size: 0.95rem; color: var(--secondary-text); }
    input, select {
      padding: 12px 12px; border: 1px solid var(--input-border); border-radius: var(--radius-sm);
      font-size: 1rem; background: var(--neutral-0); color: var(--primary-text);
      transition: border-color 0.18s ease, box-shadow 0.18s ease, background 0.18s ease;
    }
    input:focus, select:focus { border-color: var(--input-focus); outline: none; box-shadow: var(--focus-ring); background: #ffffff; }
    .helper { font-size: 0.85rem; color: var(--secondary-text); margin-top: 2px; }
    .actions {
      display: flex; justify-content: flex-end; padding: 16px 22px 22px; gap: 10px;
      border-top: 1px solid var(--divider);
      background: linear-gradient(180deg, transparent 0%, rgba(0,0,0,0.02) 100%);
      border-radius: 0 0 var(--radius-md) var(--radius-md);
    }
  </style>
</head>

<body>
  <!-- Local variables for totals and safe percentages -->
  <div class="container" th:with="
       total=${submitted + approved + reject},
       spct=${(total>0)? (submitted * 100.0) / total : 0},
       apct=${(total>0)? (approved  * 100.0) / total : 0},
       rpct=${(total>0)? (reject    * 100.0) / total : 0}">
    <div class="header">
      <div>
        <div class="title-lg">Company Overview</div>
        <div class="subtle">Live expense status across the organization</div>
      </div>

<form id="logoutForm" method="POST"></form>

<div style="display:flex; gap:10px;">
  <button id="openAddUser" class="btn">Add User</button>
  <button type="submit" form="logoutForm" formaction="/logout" class="btn">Logout</button>
</div>

    </div>

    <!-- Stats -->
    <section aria-label="Company stats">
      <div class="stats">
        <div class="stat">
          <div>
            <div class="label">Submitted</div>
            <div class="value" th:text="${submitted}">0</div>
          </div>
          <div class="pill sub" th:text="${#numbers.formatDecimal(spct,1,1)} + '%'">0%</div>
        </div>

        <div class="stat">
          <div>
            <div class="label">Approved</div>
            <div class="value" th:text="${approved}">0</div>
          </div>
          <div class="pill app" th:text="${#numbers.formatDecimal(apct,1,1)} + '%'">0%</div>
        </div>

        <div class="stat">
          <div>
            <div class="label">Rejected</div>
            <div class="value" th:text="${reject}">0</div>
          </div>
          <div class="pill rej" th:text="${#numbers.formatDecimal(rpct,1,1)} + '%'">0%</div>
        </div>

        <div class="stat">
          <div>
            <div class="label">Total</div>
            <div class="value" th:text="${total}">0</div>
          </div>
          <div class="pill tot">All</div>
        </div>
      </div>
    </section>

    <!-- Helper notes -->
    <section class="cards" aria-label="Admin notes">
      <div class="card">
        <div class="subtle">Tip</div>
        <div style="margin-top:6px;">Use Employee for standard access and Manager for team supervision roles</div>
      </div>
      <div class="card">
        <div class="subtle">Note</div>
        <div style="margin-top:6px;">New users can be created via Add User; credentials will be emailed by the backend</div>
      </div>
    </section>
  </div>

  <!-- Add User Modal -->
  <dialog id="addUserDialog" aria-labelledby="dlgTitle" aria-describedby="dlgDesc">
    <form id="addUserForm" method="dialog">
      <div class="dialog-header">
        <h2 id="dlgTitle" class="dialog-title">Add New User</h2>
        <p id="dlgDesc" class="dialog-sub">Fill in details and continue to registration</p>
      </div>

      <div class="dialog-body">
        <div class="row">
          <label for="username">Username</label>
          <input id="username" name="username" type="text" required autocomplete="username" />
        </div>

        <div class="row">
          <label for="role">Role</label>
          <select id="role" name="role" required>
            <option value="" selected disabled>Select role</option>
            <option value="ROLE_EMPLOYEE">Employee</option>
            <option value="ROLE_MANAGER">Manager</option>
          </select>
        </div>

        <div class="row">
          <label for="manager">Manager</label>
          <input id="manager" name="manager" type="text" placeholder="Manager username or ID" autocomplete="off" />
        </div>

        <div class="row">
          <label for="email">Email</label>
          <input id="email" name="email" type="email" required autocomplete="email" />
        </div>

        <div class="row">
          <label>
            <input id="sendDefaultPassword" name="sendDefaultPassword" type="checkbox" />
            Send default password
          </label>
          <div class="helper">Password will be issued by backend if this is checked.</div>
        </div>
      </div>

      <div class="actions">
        <button type="reset" id="cancelBtn" class="btn secondary">Cancel</button>
        <button type="submit" id="confirmBtn" class="btn">Continue</button>
      </div>
    </form>
  </dialog>

  <script>
    // Modal behavior and redirect to /userRegistration with query params
    const openBtn = document.getElementById('openAddUser');
    const dlg = document.getElementById('addUserDialog');
    const form = document.getElementById('addUserForm');
    const cancelBtn = document.getElementById('cancelBtn');

    const focusableSelectors = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
    function trapFocus(e) {
      const focusables = dlg.querySelectorAll(focusableSelectors);
      const first = focusables[0];
      const last = focusables[focusables.length - 1];
      if (e.key === 'Tab') {
        if (e.shiftKey && document.activeElement === first) {
          last.focus();
          e.preventDefault();
        } else if (!e.shiftKey && document.activeElement === last) {
          first.focus();
          e.preventDefault();
        }
      }
    }

    openBtn.addEventListener('click', () => {
      dlg.showModal();
      const userInput = document.getElementById('username');
      userInput && userInput.focus();
      dlg.addEventListener('keydown', trapFocus);
    });

    cancelBtn.addEventListener('click', (e) => {
      e.preventDefault();
      dlg.close();
      dlg.removeEventListener('keydown', trapFocus);
    });

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const data = new FormData(form);
      const payload = {
        username: (data.get('username') || '').toString().trim(),
        role: data.get('role') || '',
        manager: (data.get('manager') || '').toString().trim(),
        email: (data.get('email') || '').toString().trim(),
        sendDefaultPassword: data.get('sendDefaultPassword') === 'on'
      };
      const params = new URLSearchParams();
      if (payload.username) params.set('username', payload.username);
      if (payload.role) params.set('role', payload.role);
      if (payload.email) params.set('email', payload.email);
      if (payload.manager) params.set('manager', payload.manager);
      if (payload.sendDefaultPassword) params.set('sendDefaultPassword', 'true');

      dlg.close();
      dlg.removeEventListener('keydown', trapFocus);
      window.location.assign('/userRegistration?' + params.toString());
    });
  </script>
</body>
</html>
